name: Build STunnel APK
on: [workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK and Android
        run: |
          # Устанавливаем необходимые пакеты
          sudo apt-get update
          sudo apt-get install -y zip unzip openjdk-17-jdk
      
      - name: Create Android APK from binary
        run: |
          echo "=== Создаём APK из бинарника stunnel ==="
          
          # 1. Создаём временную структуру APK
          mkdir -p stunnel-apk/{assets,META-INF,lib,res}
          
          # 2. Копируем бинарник stunnel
          if [ -f "stunnel" ]; then
            echo "Копируем stunnel из корня..."
            cp stunnel stunnel-apk/assets/
          elif [ -f "app/src/main/assets/stunnel" ]; then
            echo "Копируем stunnel из app/src/main/assets..."
            cp app/src/main/assets/stunnel stunnel-apk/assets/
          else
            echo "❌ ОШИБКА: Бинарник stunnel не найден!"
            echo "Ищем stunnel файлы..."
            find . -name "stunnel" -type f
            exit 1
          fi
          
          # 3. Создаём минимальный AndroidManifest.xml
          cat > stunnel-apk/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.example.stunnel"
              android:versionCode="1"
              android:versionName="1.0">
              <uses-sdk android:minSdkVersion="21" android:targetSdkVersion="34"/>
              <application 
                  android:label="STunnel Client"
                  android:icon="@mipmap/ic_launcher"
                  android:allowBackup="true">
              </application>
          </manifest>
          EOF
          
          # 4. Создаём необходимые папки ресурсов
          mkdir -p stunnel-apk/res/{drawable,mipmap-hdpi,mipmap-mdpi,mipmap-xhdpi}
          
          # 5. Создаём пустой classes.dex (обязательный для Android)
          echo "Создаём classes.dex..."
          cat > stunnel-apk/classes.dex << 'EOF'
          # Пустой classes.dex - минимальный требуемый файл
          EOF
          
          # 6. Создаём META-INF с манифестом
          cat > stunnel-apk/META-INF/MANIFEST.MF << 'EOF'
          Manifest-Version: 1.0
          Created-By: GitHub Actions
          EOF
          
          # 7. Создаём APK (ZIP архив с определённой структурой)
          echo "Создаём APK файл..."
          cd stunnel-apk
          zip -r ../stunnel-android.apk . -x ".*" -x "__MACOSX"
          cd ..
          
          # 8. Подписываем APK (минимальная подпись)
          echo "Создаём тестовый ключ и подписываем APK..."
          keytool -genkey -v -keystore test.keystore -alias androidkey \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug, O=Android, C=US" \
            -storepass android -keypass android 2>/dev/null || true
          
          jarsigner -verbose -keystore test.keystore \
            -storepass android -keypass android \
            stunnel-android.apk androidkey 2>/dev/null || echo "Подпись пропущена"
          
          echo "=== РЕЗУЛЬТАТ ==="
          echo "✅ APK создан: stunnel-android.apk"
          ls -lh *.apk
          echo "Размер: $(du -h stunnel-android.apk | cut -f1)"
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: stunnel-client
          path: stunnel-android.apk
          retention-days: 7
