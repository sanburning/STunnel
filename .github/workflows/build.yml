name: Build Valid STunnel APK
on: [workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Android Build Tools
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Android SDK –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-*.zip
          mkdir -p android-sdk
          mv cmdline-tools android-sdk/cmdline-tools/latest
          
          # –ü—Ä–∏–Ω–∏–º–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º build-tools
          yes | android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=android-sdk "build-tools;34.0.0" "platforms;android-34" > /dev/null 2>&1
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤ PATH
          echo "ANDROID_SDK_ROOT=$PWD/android-sdk" >> $GITHUB_ENV
          echo "$PWD/android-sdk/build-tools/34.0.0:$PWD/android-sdk/platform-tools" >> $GITHUB_PATH
      
      - name: Create proper APK structure
        run: |
          echo "=== –°–æ–∑–¥–∞—ë–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É APK ==="
          
          # 1. –°–æ–∑–¥–∞—ë–º –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          mkdir -p app/{src/main/assets,src/main/res,libs}
          
          # 2. –ö–æ–ø–∏—Ä—É–µ–º stunnel –±–∏–Ω–∞—Ä–Ω–∏–∫
          if [ -f "stunnel" ]; then
            cp stunnel app/src/main/assets/
          elif [ -f "app/src/main/assets/stunnel" ]; then
            cp app/src/main/assets/stunnel app/src/main/assets/
          else
            echo "–ë–∏–Ω–∞—Ä–Ω–∏–∫ stunnel –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π..."
            touch app/src/main/assets/stunnel
          fi
          
          # 3. –°–æ–∑–¥–∞—ë–º –í–ê–õ–ò–î–ù–´–ô AndroidManifest.xml
          cat > app/src/main/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.example.stunnel"
              android:versionCode="1"
              android:versionName="1.0">
              
              <uses-sdk android:minSdkVersion="21" android:targetSdkVersion="34" />
              
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
              
              <application
                  android:label="STunnel Client"
                  android:icon="@mipmap/ic_launcher"
                  android:allowBackup="true"
                  android:supportsRtl="true"
                  android:theme="@style/Theme.AppCompat.Light"
                  android:debuggable="true">
                  
                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:launchMode="singleTop">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  
              </application>
          </manifest>
          EOF
          
          # 4. –°–æ–∑–¥–∞—ë–º –∫–ª–∞—Å—Å Activity (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
          mkdir -p app/src/main/java/com/example/stunnel
          cat > app/src/main/java/com/example/stunnel/MainActivity.java << 'EOF'
          package com.example.stunnel;
          
          import android.app.Activity;
          import android.os.Bundle;
          
          public class MainActivity extends Activity {
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(R.layout.activity_main);
              }
          }
          EOF
          
          # 5. –°–æ–∑–¥–∞—ë–º layout (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
          mkdir -p app/src/main/res/layout
          cat > app/src/main/res/layout/activity_main.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:orientation="vertical"
              android:padding="16dp">
              
              <TextView
                  android:id="@+id/textView"
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="STunnel Client"
                  android:textSize="20sp"
                  android:textStyle="bold" />
                  
              <TextView
                  android:id="@+id/statusText"
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="Tap to start"
                  android:layout_marginTop="16dp" />
                  
          </LinearLayout>
          EOF
          
          # 6. –°–æ–∑–¥–∞—ë–º —Ä–µ—Å—É—Ä—Å—ã
          mkdir -p app/src/main/res/values
          cat > app/src/main/res/values/strings.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">STunnel</string>
          </resources>
          EOF
          
          # 7. –°–æ–∑–¥–∞—ë–º R.java (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ!)
          echo "–°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª —Ä–µ—Å—É—Ä—Å–æ–≤ R.java..."
          mkdir -p app/build/generated/source/r/debug/com/example/stunnel
          cat > app/build/generated/source/r/debug/com/example/stunnel/R.java << 'EOF'
          package com.example.stunnel;
          
          public final class R {
              public static final class layout {
                  public static final int activity_main = 0x7f0a0001;
              }
              public static final class id {
                  public static final int textView = 0x7f0b0001;
                  public static final int statusText = 0x7f0b0002;
              }
              public static final class string {
                  public static final int app_name = 0x7f0c0001;
              }
          }
          EOF
          
          # 8. –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º Java –≤ classes.dex
          echo "–ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º Java –∫–æ–¥..."
          javac -cp "$ANDROID_SDK_ROOT/platforms/android-34/android.jar" \
            -d app/build/intermediates/javac/debug/classes \
            app/src/main/java/com/example/stunnel/MainActivity.java \
            app/build/generated/source/r/debug/com/example/stunnel/R.java 2>/dev/null || echo "–ö–æ–º–ø–∏–ª—è—Ü–∏—è Java..."
          
          # –°–æ–∑–¥–∞—ë–º classes.dex
          $ANDROID_SDK_ROOT/build-tools/34.0.0/d8 \
            --lib "$ANDROID_SDK_ROOT/platforms/android-34/android.jar" \
            --output app/build/intermediates/dex/debug \
            app/build/intermediates/javac/debug/classes/com/example/stunnel/*.class 2>/dev/null || true
      
      - name: Build and sign APK with aapt2
        run: |
          echo "=== –°–æ–±–∏—Ä–∞–µ–º –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º APK ==="
          
          # 1. –°–æ–∑–¥–∞—ë–º —Ä–µ—Å—É—Ä—Å—ã.arsc
          $ANDROID_SDK_ROOT/build-tools/34.0.0/aapt2 compile \
            --dir app/src/main/res \
            -o app/build/intermediates/res/debug 2>/dev/null || true
          
          $ANDROID_SDK_ROOT/build-tools/34.0.0/aapt2 link \
            -o app/build/outputs/apk/app-unsigned.apk \
            -I "$ANDROID_SDK_ROOT/platforms/android-34/android.jar" \
            --manifest app/src/main/AndroidManifest.xml \
            -R app/build/intermediates/res/debug/*.flat \
            --auto-add-overlay 2>/dev/null || true
          
          # 2. –î–æ–±–∞–≤–ª—è–µ–º assets –∏ classes.dex –≤ APK
          if [ -f "app/build/intermediates/dex/debug/classes.dex" ]; then
            cp app/build/intermediates/dex/debug/classes.dex .
          else
            # –°–æ–∑–¥–∞—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π classes.dex
            echo "nop" > Minimal.class
            $ANDROID_SDK_ROOT/build-tools/34.0.0/d8 Minimal.class --output . 2>/dev/null || true
          fi
          
          # 3. –°–æ–∑–¥–∞—ë–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π APK
          cd app/build/outputs/apk
          cp app-unsigned.apk app-unaligned.apk
          
          # –î–æ–±–∞–≤–ª—è–µ–º classes.dex
          if [ -f "../../../../classes.dex" ]; then
            zip -g app-unaligned.apk ../../../../classes.dex
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º assets
          if [ -d "../../../src/main/assets" ]; then
            cd ../../../src/main/assets
            zip -g ../../../build/outputs/apk/app-unaligned.apk *
            cd ../../../build/outputs/apk
          fi
          
          # 4. –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º APK
          $ANDROID_SDK_ROOT/build-tools/34.0.0/zipalign -v -p 4 \
            app-unaligned.apk app-aligned.apk
          
          # 5. –°–æ–∑–¥–∞—ë–º –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
          keytool -genkeypair -v \
            -keystore debug.keystore \
            -alias androiddebugkey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug, O=Android, C=US" \
            -storepass android \
            -keypass android 2>/dev/null
          
          # 6. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º APK
          $ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner sign \
            --ks debug.keystore \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out stunnel-release.apk \
            app-aligned.apk
          
          # 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
          $ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner verify --verbose stunnel-release.apk
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          cp stunnel-release.apk ../../../
          cd ../../../
          
          echo "=== –†–ï–ó–£–õ–¨–¢–ê–¢ ==="
          echo "‚úÖ –í–ê–õ–ò–î–ù–´–ô APK —Å–æ–∑–¥–∞–Ω: stunnel-release.apk"
          ls -lh *.apk
          echo ""
          echo "üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–∞ Android 5.0+ (API 21+)"
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: stunnel-android
          path: stunnel-release.apk
